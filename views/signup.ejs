<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>

    <!-- axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>회원가입</h1>

    <form name = "form_position" action = "/sign/position" method = "GET">
        <input type = "hidden" name = "user_id">
    </form>



    <form name="form_register">
        <div id = "id">
            <label for = "user_id">아이디</label>
            <input id = "user_id" name = "user_id" type = "text" required>
            <button type = "button" onclick = "idTest();">중복확인</button><br>
            <div id = "idTestText"></div>
        </div>

        <div id = "pw">
            <label for = "user_pw">비밀번호</label>
            <input id = "user_pw" name = "user_pw" type = "password" required><br>
        </div>

        <div id = "name">
            <label for = "user_name">이름</label>        
            <input id = "user_name" name = "user_name" type = "text" required><br>
        </div>

        <div id = "email">
            <label for = "user_email">이메일</label>
            <input id = "user_email" name = "user_email" type = "email" required>
            <button type = "button"  onclick = "emailTest();">중복확인</button><br>
            <div id = "emailTestText"></div>
        </div>

        <button type = "button" onclick = "register();">회원가입</button>
    </form>

    <a href = "/sign/signin">로그인</a>


    <script>
        const idTestText = document.querySelector('#idTestText');
        const emailTestText = document.querySelector('#emailTestText');

        console.log('idTestTest: ', idTestText);
        console.log('emailTestTExt', emailTestText);


        function register(){
            const form = document.forms['form_register'];
            
            console.log(form)
            console.log('pw확인>>', form.user_pw);
            console.log(form.checkValidity())

            //폼 유효성 검사
            /*if (!form.checkValidity()) { //!false -> true
                form.reportValidity(); // 주황색 입력란을 뜨게 만들 수 있다.
                return;
              }*/

            axios({
                method: 'POST',
                url: '/sign/signup',
                data: {
                    user_id: form.user_id.value,
                    user_pw: form.user_pw.value,
                    user_name: form.user_name.value,
                    user_email: form.user_email.value,
                },
            }).then((res) => {
                console.log('res', res);
                return res.data;
            }).then((data) => { //이메일 중복X->then
                console.log('data', data);
                alert('회원가입 성공');

                const form_position = document.forms['form_position'];
                form_position.user_id.value = form.user_id.value;
                form_position.submit();

                //document.location.href = '/sign/position';
                //document.location.href = '/sign/signin';
            }).catch((data) => { //이메일 중복O -> catch
                // alert('이미 가입된 이메일입니다.');
            })
        }

        function idTest(){
            const form = document.forms['form_register'];
            console.log('form.user_id', form.user_id);
            console.log('form.user_id.value', form.user_id.value)
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            axios({
                method: 'POST',
                url: '/sign/signup/id',
                data:{
                    user_id: form.user_id.value,
                },
            }).then((res) => {
                return res.data;
            }).then((data) => {
                console.log('data>> ', data);
                 if(!data){ //data = false
                    idTestText.textContent = `"${form.user_id.value}"는 존재하는 아이디입니다.`
                    idTestText.style.color = 'red';
                }
                else{
                    idTestText.textContent = `"${form.user_id.value}"는 사용 가능한 아이디입니다.`
                    idTestText.style.color = 'red';
                }
            })
        }

        function emailTest(){
            const form = document.forms['form_register'];
            console.log('form of emailTest >> ', form);

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            axios({
                method: 'POST',
                url: '/sign/signup/email',
                data: {
                    user_email: form.user_email.value
                }
            }).then((res) => {
                return res.data;
            }).then((data) => {
                if(!data){ //data == false
                    emailTestText.textContent = '이미 가입한 이메일입니다.';
                    emailTestText.style.color = "red";
                }
                else{ //data == true
                    emailTestText.textContent = '사용 가능한 이메일입니다.';
                    emailTestText.style.color = "red";
                }
            })
        }
    </script>
</body>
</html>